# Nginx Reverse Proxy Deployment
{{- if .Values.nginx.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-proxy-{{ .Values.environment }}
  labels:
    app: nginx-proxy
    environment: {{ .Values.environment }}
spec:
  replicas: {{ .Values.nginx.replicaCount }}
  selector:
    matchLabels:
      app: nginx-proxy
      environment: {{ .Values.environment }}
  template:
    metadata:
      labels:
        app: nginx-proxy
        environment: {{ .Values.environment }}
    spec:
      containers:
        - name: nginx
          image: "{{ .Values.nginx.image.repository }}:{{ .Values.nginx.image.tag }}"
          imagePullPolicy: {{ .Values.nginx.image.pullPolicy }}
          ports:
            - containerPort: {{ .Values.nginx.service.targetPort }}
          volumeMounts:
            - name: nginx-config
              mountPath: /etc/nginx/conf.d/default.conf
              subPath: nginx.conf
      volumes:
        - name: nginx-config
          configMap:
            name: nginx-config-{{ .Values.environment }}

---
# Nginx Service
apiVersion: v1
kind: Service
metadata:
  name: nginx-proxy-{{ .Values.environment }}
  labels:
    app: nginx-proxy
    environment: {{ .Values.environment }}
spec:
  type: {{ .Values.nginx.service.type }}
  selector:
    app: nginx-proxy
    environment: {{ .Values.environment }}
  ports:
    - port: {{ .Values.nginx.service.port }}
      targetPort: {{ .Values.nginx.service.targetPort }}
      nodePort: {{ .Values.nginx.service.nodePort }}

---
# Nginx ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config-{{ .Values.environment }}
  labels:
    app: nginx-proxy
    environment: {{ .Values.environment }}
data:
  nginx.conf: |
    server {
        listen {{ .Values.nginx.service.targetPort }};
        
        location /api/v1/movies/ {
            proxy_pass http://movie-service-{{ .Values.environment }}:{{ .Values.movieService.service.port }}/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        location /api/v1/casts/ {
            proxy_pass http://cast-service-{{ .Values.environment }}:{{ .Values.castService.service.port }}/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        location / {
            return 200 '{"message": "Microservices API Gateway - Environment: {{ .Values.environment }}"}';
            add_header Content-Type application/json;
        }
    }
{{- end }}